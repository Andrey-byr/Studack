<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система управления студенческими общежитиями</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="navigation">
            <button class="nav-btn back-btn" type="button">
                Назад
            </button>
            
            <div class="theme-controls">
                <button class="nav-btn theme-btn" type="button" id="themeBtn">
                    Тёмная тема
                </button>
            </div>
        </div>

        <div class="header-image"></div>
        
        <h1>Система управления студенческими общежитиями</h1>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">Всего студентов</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="occupiedRooms">0</div>
                <div class="stat-label">Занято комнат</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgGrade">0.0</div>
                <div class="stat-label">Средний балл</div>
            </div>
        </div>
        
        <div class="button-container">
            <button class="nav-btn fetch-btn" type="button">
                Обновить данные студентов
            </button>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            Загрузка данных из базы данных...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="studentInfo" class="student-info" style="display: none;">
            <!-- Информация о студентах будет загружена здесь -->
        </div>
    </div>
    
    <script>
        // Проверяем, открыт ли файл напрямую
        if (window.location.protocol === 'file:') {
            // Создаем сообщение об ошибке
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background: #e74c3c;
                color: white;
                padding: 20px;
                text-align: center;
                z-index: 10000;
                font-family: Arial, sans-serif;
            `;
            errorDiv.innerHTML = `
                <h3>⚠️ Внимание!</h3>
                <p>Для корректной работы приложения необходимо запустить локальный сервер.</p>
                <p><strong>Команда для запуска:</strong></p>
                <code style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; display: inline-block; margin: 10px 0;">
                    cd "/Users/andrejburak/Desktop/проект /Studack/merger" && php -S localhost:8000
                </code>
                <p>Затем откройте: <a href="http://localhost:8000" style="color: #3498db; text-decoration: underline;">http://localhost:8000</a></p>
                <button onclick="this.parentElement.style.display='none'" style="background: #34495e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    Закрыть
                </button>
            `;
            document.body.prepend(errorDiv);
        }

        // Функция для отправки сигнала остановки сервера
        function sendStopSignal() {
            // Создаем скрытый iframe для отправки запроса без блокировки закрытия страницы
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = 'http://localhost:8000/stop-server.php';
            document.body.appendChild(iframe);
            
            // Также пробуем отправить fetch запрос (на всякий случай)
            fetch('http://localhost:8000/stop-server.php', {
                method: 'GET',
                mode: 'no-cors',
                cache: 'no-cache'
            }).catch(() => {
                // Игнорируем ошибки, так как сервер может уже остановиться
            });
        }

        // Отправляем сигнал серверу при закрытии вкладки/браузера
        window.addEventListener('beforeunload', function() {
            sendStopSignal();
        });

        // Также отправляем сигнал при выгрузке страницы
        window.addEventListener('unload', function() {
            sendStopSignal();
        });

        // Отправляем сигнал при закрытии страницы через Ctrl+W или другие способы
        window.addEventListener('pagehide', function() {
            sendStopSignal();
        });

        // Дополнительная защита: отправляем сигнал при потере фокуса (если пользователь переключается на другое приложение)
        window.addEventListener('blur', function() {
            // Только если страница неактивна более 30 секунд, считаем что пользователь ушел
            setTimeout(() => {
                if (!document.hasFocus()) {
                    sendStopSignal();
                }
            }, 30000);
        });

        // Отслеживаем неактивность пользователя
        let userActivityTimeout;
        function resetUserActivity() {
            clearTimeout(userActivityTimeout);
            userActivityTimeout = setTimeout(() => {
                // Если пользователь неактивен более 5 минут, отправляем сигнал остановки
                sendStopSignal();
            }, 300000); // 5 минут
        }

        // Сбрасываем таймер при активности пользователя
        document.addEventListener('mousemove', resetUserActivity);
        document.addEventListener('keypress', resetUserActivity);
        document.addEventListener('click', resetUserActivity);
        
        // Инициализируем таймер неактивности
        resetUserActivity();
    </script>
    
    <script src="js/script.js"></script>
</body>
</html>